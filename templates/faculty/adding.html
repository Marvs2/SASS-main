{% extends "faculty/layout.html" %} {% block content %}

<!-- Progress bar -->
<div class="progressbar">
  <div class="progress1" id="progress1"></div>
  <div
    class="progress-step progress-step-active"
    data-title="Current Subjects"
  ></div>
  <div class="progress-step" data-title="Add Subject/s"></div>
  <div class="progress-step" data-title="Payment"></div>
  <div class="progress-step" data-title="Review Subject"></div>
</div>

<!-- SHOW CURRENT SUBJECT -->
<div class="form-step form-step-active">
  <div class="data data1" id="firstTableContainer">
    <div class="content-data">
      <div class="head mb-3">
        <h3>Current Request</h3>
      </div>

      <table
        id="addingSubject"
        class="table table-bordered table-condensed display"
      >
        <thead>
          <tr>
            <th>Subject ID</th>
            <th>Student ID</th>
            <th>Faculty Role</th>
            <th>Subject</th>
            <th>Service Details</th>
            <th>Sender Name</th>
            <th>Contact No</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for subject in addsubjects %}
          <tr>
            <td>{{ subject.AddSubjectId }}</td>
            <td>{{ subject.StudentId }}</td>
            <td>{{ subject.FacultyRole }}</td>
            <td>{{ subject.Subject }}</td>
            <td>{{ subject.ServiceDetails }}</td>
            <td>{{ subject.SenderName }}</td>
            <td>{{ subject.SenderContactNo }}</td>
            <td>{{ subject.Status }}</td>
            <td>
              <button type="button" class="btn btn-primary" onclick="openEditModal({{ subject.AddSubjectId }}, '{{ subject.Status }}')">Edit Status</button>
          </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="d-flex justify-content-end mt-3">
        <button type="button" class="btn btn-primary btn-next">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Edit Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" role="dialog" aria-labelledby="editStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="statusForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editStatusModalLabel">Edit Status</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="subjectIdInput" name="subjectId">
            <select id="statusSelect" name="status" class="form-control">
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
<script>
 document.getElementById('statusForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const subjectId = document.getElementById('subjectIdInput').value;
  const newStatus = document.getElementById('statusSelect').value;
  
  // AJAX request to Flask backend
  fetch('/update_status', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subjectId: subjectId,
      status: newStatus
    })
  })
  .then(response => response.json())
  .then(data => {
    console.log('Success:', data);
    $('#editStatusModal').modal('hide');
    location.reload(); // Reload the page to see the changes
  })
  .catch((error) => {
    console.error('Error:', error);
  });
});

function openEditModal(subjectId, currentStatus) {
  document.getElementById('subjectIdInput').value = subjectId;
  document.getElementById('statusSelect').value = currentStatus;
  $('#editStatusModal').modal('show');
}
</script>
{% endblock %}
