{% extends "faculty/layout.html" %}

{% block content %}
  <!-- SHOW CURRENT SUBJECT -->
  <div class="form-step form-step-active">
    <div class="data data1" id="firstTableContainer">
      <div class="content-data">
        <div class="head mb-3">
          <h3>Current Request</h3>
        </div>

        <table id="addingSubject" class="table table-bordered table-condensed display">
          <thead>
            <tr>
              <th>Application Number</th>
              <th>Student Number</th>
              <th>Student Name</th>
              <th>Subject</th>
              <!-- <th>Service Details</th> -->
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for subject, student in combined_data %}
              <tr data-add-name="{{ student.FirstName }} {{ student.LastName }}"

                  data-add-student-Number="{{ student.StudentNumber }}"
                  data-add-subject="{{ subject.Subject }}"
                  data-add-reason="{{ subject.ServiceDetails }}"
                  data-add-sender="{{ subject.SenderName }}"
                  data-add-contact="{{ subject.SenderContactNo }}"
                  data-add-file="{{ subject.PaymentFile }}"
                  data-add-status="{{ subject.Status }}">
                 <td>{{ subject.StudentId }}</td>
                 <td>{{ student.StudentNumber }}</td>
                 <td>{{ student.FirstName }} {{ student.LastName }}</td>
                <td>{{ subject.Subject }}</td>
                <!-- <td>{{ subject.ServiceDetails }}</td> -->
                <!-- <td>{{ subject.SenderName }}</td>
                <td>{{ subject.SenderContactNo }}</td> -->
                <td>{{ subject.Status }}</td>
                <td>
                  <button type="button" title="View Info" class="btn btn-primary fa-solid fa-eye edit_btn" data-toggle="modal" data-target="#viewAddModal" onclick="openEditModal('{{ subject.AddSubjectId }}', '{{ subject.Status }}')"></button>
                  <button type="button" title="Delete Info" class="btn btn-danger fa-solid fa-trash delete_btn" data-toggle="modal" data-target="#deleteModal"></button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Status Edit Modal -->
  <div class="modal fade" id="viewAddModal" tabindex="-1" role="dialog" aria-labelledby="viewAddModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="viewAddModalLabel">Update Application Status</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form id="statusForm">
                <div class="modal-body">
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Name:</label>
                      <div class="col-sm-4">
                        <p id="adding-name"></p>
                      </div>          
                    </div>

                    <div class="form-group">
                      <label class="col-sm-3 control-label">Subject to Add:</label>
                      <div class="col-sm-6">
                        <p id="adding-student-subject"></p>
                      </div>          
                    </div>

                    <div class="form-group">
                      <label class="col-sm-3 control-label">Reason/s:</label>
                      <div class="col-sm-4">
                        <p id="adding-student-reason"></p>
                      </div>          
                    </div>
            
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Sender Name:</label>
                      <div class="col-sm-4">
                        <p id="adding-sender-name"></p>
                      </div>          
                    </div>
            
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Sender Contact Number:</label>
                      <div class="col-sm-4">
                        <p id="adding-sender-contact"></p>
                      </div>          
                    </div>
            
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Payment file:</label>
                      <div class="col-sm-4">
                        <p id="adding-file-attachment"></p>
                      </div>          
                    </div>
                            
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Status:</label>
                      <div class="col-sm-4">
                        <input type="hidden" id="subjectIdInput" name="subjectId">
                          <select id="statusSelect" name="status" class="form-control">
                              <option value="Pending">Pending</option>
                              <option value="Approved">Approved</option>
                              <option value="Completed">Completed</option>
                              <option value="Rejected">Rejected</option>
                          </select>
                      </div>          
                    </div>

<div id="overloadTableContainer">
    <h1>Overload Applications</h1>
    <table id="overloadTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Student Number</th>
                <th>Program/Course</th>
                <th>Semester</th>
                <th>Subjects to Add</th>
                <th>Justification</th>
                <th>Files</th>
                <th>User Responsible</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Replace with your Flask template logic to populate rows -->
            {% for overload_applications in overload_applications %}
                <tr>
                    <td>{{ overload_applications.OverloadId }}</td>
                    <td>{{ overload_applications.Name }}</td>
                    <td>{{ overload_applications.StudentNumber }}</td>
                    <td>{{ overload_applications.ProgramCourse }}</td>
                    <td>{{ overload_applications.Semester }}</td>
                    <td>{{ overload_applications.SubjectsToAdd }}</td>
                    <td>{{ overload_applications.Justification }}</td>
                    <td>
                        {% if overload_applications.Overloaddata %}
                            {% set truncated_overload_name = overload_applications.Overloadfilename[:15] + '...' if overload_applications.Overloadfilename|length > 15 else overload_applications.Overloadfilename %}
                        <a href="{{ url_for('get_overload_file', overload_application_id=overload_applications.OverloadId) }}" class="btn btn-success" download title="{{ overload_applications.Overloadfilename }}">{{ truncated_overload_name }}</a>
                        {% else %}
                        <span class="badge badge-warning">No File</span>
                        {% endif %}
                      </td>
                    <td>{{ overload_applications.UserResponsible }}</td>
                    <td>{{ overload_applications.Status }}</td>
                    <td>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#statusModal{{ overload_applications.OverloadId }}">Change Status</button>
                      </td>
                </tr>
                <!-- Modal for Changing Status -->
      <div class="modal fade" id="statusModal{{ overload_applications.OverloadId }}" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="statusModalLabel">Change Status for {{ overload_applications.Name }}</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span></button>
            </div>
            <form id="statusForm{{ overload_applications.OverloadId }}" action="{{ url_for('update_overload_service_status', OverloadId=overload_applications.OverloadId) }}" method="POST">
              <div class="modal-body">
                <select name="status" class="form-select">
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="approved">Approved</option>
                  <option value="finish">Finish</option>
                  <option value="rejected">Rejected</option>
                  <!-- Add other statuses as needed -->
                </select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button  type="submit" class="btn btn-primary" onclick="updateStatus({{ overload_applications.OverloadId }})">Save Status</button>

              </div>
            </form>
        </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      $('#addingSubject tbody tr').on('click', function () {
        // Retrieve data from the clicked row
        var name = $(this).data('add-name');
        var studentNumber = $(this).data('add-student-Number');
        var subject = $(this).data('add-subject'); 
        var reason = $(this).data('add-reason'); 
        var sender = $(this).data('add-sender'); 
        var contact = $(this).data('add-contact'); 
        var fileAttachment = $(this).data('add-file');
        var status = $(this).data('add-status'); // Add this line to get the status
  
        // Populate modal with data
        $('#adding-name').text(name);
        $('#adding-student-number').text(studentNumber);
        $('#adding-student-subject').text(subject);
        $('#adding-student-reason').text(reason);
        $('#adding-sender-name').text(sender);
        $('#adding-sender-contact').text(contact);
        $('#adding-file-attachment').text(fileAttachment);
  
        // Additional logic for handling status-related changes
        handleStatusChange(status);
      });
    });
  
    function handleStatusChange(currentStatus) {
      var statusDropdown = $('#statusSelect');
      var updateButton = $('#updateBtn');
  
      // Enable/disable options based on the selected status
      statusDropdown.find('option').prop('disabled', false);
  
      switch (currentStatus) {
        case 'Pending':
          // Admin can only change to 'Approved'
          statusDropdown.find('option[value="Pending"]').prop('disabled', true);
          statusDropdown.find('option[value="Completed"]').prop('disabled', true);
          break;
        case 'Approved':
          // Admin can change to 'Completed'
          statusDropdown.find('option[value="Pending"]').prop('disabled', true);
          statusDropdown.find('option[value="Approved"]').prop('disabled', true);
          break;
        case 'Completed':
          // Disable all options when status is 'Completed'
          statusDropdown.find('option').prop('disabled', true);
          break;
        case 'Rejected':
          // Admin cannot change to any other status
          statusDropdown.find('option').prop('disabled', true);
          break;
        default:
          break;
      }
  
      // Set the current status as selected
      statusDropdown.val(currentStatus);
  
      // Enable/disable "Update" button based on the selected status
      updateButton.prop('disabled', true);
  
      // Bind an event handler to the status dropdown to check for changes
      statusDropdown.on('change', function () {
        updateButton.prop('disabled', false);
      });
  
      if (currentStatus === 'Closed') {
        statusDropdown.prop('disabled', true);
      } else {
        statusDropdown.prop('disabled', false);
      }
    }
  
    function openEditModal(subjectId, currentStatus) {
      $('#subjectIdInput').val(subjectId);
      handleStatusChange(currentStatus);
    }
  
    function submitStatus() {
      const subjectId = $('#subjectIdInput').val();
      const newStatus = $('#statusSelect').val();
      const remarks = $('#remarks').val(); // Get remarks value
  
      // AJAX request to Flask backend
      fetch('/update_status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          subjectId: subjectId,
          status: newStatus,
          remarks: remarks, // Include remarks in the request
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          $('#viewAddModal').modal('hide');
          location.reload(); // Reload the page to see the changes
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }
</script>
{% endblock %}
   