{% extends "student/layout.html" %}

{% block content %}

  <!-- Progress bar -->
  <div class="progressbar">
    <div class="progress1" id="progress1"></div>
    <div class="progress-step progress-step-active" data-title="Current Subjects"></div>
    <div class="progress-step" data-title="Add Subject/s"></div>
    <div class="progress-step" data-title="Payment"></div>
    <div class="progress-step" data-title="Review Subject"></div>
  </div>

  <!-- SHOW CURRENT SUBJECT -->
  <div class="form-step form-step-active">
    <div class="data data1" id="firstTableContainer">
      
      <div class="content-data">
        <div class="head mb-3">
          <h3>Current Subjects</h3>
        </div>

        <div class="row mb-3">
          <span class="mb-3">  
            <b>Student:</b>
            <input type="text" class="form-control" name="Name" title="Name" id="Name" readonly>
          </input>
          </span>

          <span>
            <b>Course:</b> {% if course %} {{ course.CourseCode }} {% endif %}
          </span>
        </div>

        <table id="addingSubject" class="table table-bordered table-condensed display">
          <thead>
            <tr>
              <th>Subject Code</th>
              <th>Subject Name</th>
              <th>Description</th>
              <th>Units</th>
            </tr>
          </thead>
          <tbody>
            {% for subject in subject_list %}
              <tr
                data-subject-code="{{ subject.SubjectCode }}"
                data-subject-description="{{ subject.Name }}"
                data-Description="{{ subject.Description }}"
                data-Units="{{ subject.Units }}"
                data-IsNSTP="{{ subject.IsNSTP }}"
              >
                <td>{{ subject.SubjectCode }}</td>
                <td>{{ subject.Name }}</td>
                <td>{{ subject.Description }}</td>
                <td>{{ subject.Units }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-primary btn-next">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SHOW OPTION FOR ADDING OF SUBJECTS  -->

  <div class="form-step">
    <div class="data data1"  id="reviewHeading">
      <div class="content-data">
        <div class="head mb-3">
          <h3>Review Selected Subjects</h3>
        </div>

        <!-- Review Table for Selected Subjects -->
        <table class="table table-bordered table-condensed" id="reviewSubjectsTable">
          <thead>
            <tr>
              <th></th>
              <th>Subject Code</th>
              <th>Subject Name</th>
              <th>Description</th>
              <th>Units</th>
            </tr>
          </thead>
          <tbody>
            <!-- Selected subjects will be added here -->
          </tbody>
        </table>
      </div>
      </div>

      <div class="data data1">
        <div class="content-data">

        <div class="head mb-3">
          <h3>Add Subjects</h3>
        </div>
          <!-- Table for Displaying Subjects to Select -->
          <table id="selectedSubjectsTable" class="table table-bordered table-condensed">
            <thead>
              <tr>
                <th></th>
                <th>Subject Code</th>
                <th>Subject Name</th>
                <th>Description</th>
                <th>Units</th>
              </tr>
            </thead>
            <tbody>
              {% for selections in selection_list %}
                <tr
                  data-subject-code="{{ selections.SubjectCode }}"
                  data-Description="{{ selections.Description }}"
                  data-subject-description="{{ selections.Name }}"
                  data-Units="{{ selections.Units }}">
                  <td>
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" name="checkbox" title="checkbox" class="custom-control-input selections-checkbox" id="checkbox{{ selections.SubjectId }}" onclick="handleCheckboxClick(this);"/>

                      <label class="custom-control-label" for="checkbox{{ selections.SubjectId }}"></label>
                    </div>
                  </td>
                  <td>{{ selections.SubjectCode }}</td>
                  <td>{{ selections.Name }}</td>
                  <td>{{ selections.Description }}</td>
                  <td>{{ selections.Units }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-primary btn-prev">Previous</button>
            <button type="button" class="btn btn-primary btn-next ml-2">Next</button>
          </div>
      </div>
    </div>
  </div>

  <!-- PAYMENT-->
  <div class="form-step">
    <div class="data data1">
      <div class="content-data">
        <div class="head mb-5">
          <h3 id="user-info">Payment</h3>
        </div>

        <form method="POST" action="/submit" enctype="multipart/form-data">
          <div class="row mb-5">
            <label for="name" class="col-sm-2 col-form-label">Sender Name</label>
            <div class="col-sm-8">
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          </div>

          <div class="row mb-5">
            <label for="MobileNumber" class="col-sm-2 col-form-label">Number</label>
            <div class="col-sm-8">
              <input type="text" class="form-control" name="MobileNumber" id="MobileNumber" required="required" maxlength="11" pattern="\d{11}">
          </div>
          </div>
        
          <div class="row mb-5">
            <label for="paymentScreenshot" class="col-sm-2 col-form-label">Proof of Payment</label>
            <div class="col-sm-8">
              <input type="file" class="form-control" id="paymentScreenshot" name="paymentScreenshot" required>
          </div>
          </div>
      
          <!-- <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="agreeTerms" name="agreeTerms">
            <label class="form-check-label" for="agreeTerms">I agree to the terms and conditions</label>
          </div>          -->
        </form>        

        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-primary btn-prev">Previous</button>
          <button type="button" class="btn btn-primary btn-next ml-2"  onclick="showResponse()">Next</button>
        </div>
        
      </div>
    </div>
  </div>

<!-- REVIEW TRANSACTIONS -->
<div class="form-step">
  <div class="data data1">
    <div class="content-data">
      <div class="head mb-5">
        <h3>Review Transactions</h3>
      </div>

      <form id="serviceRequestForm" action="{{url_for('submitapplication')}}" method="POST" enctype="multipart/form-data">
      <!-- Hidden field for student ID (assuming it's available in the session or a similar context) -->
      <input type="hidden" name="StudentId" title="text" value="{{ session['user_id'] }}"/>
      <input type="hidden" id="selectedSubjects" title="text" name="selectedSubjects" value="">
      <input type="hidden" id="SenderNameHidden" title="text" name="SenderName" value="">
      <input type="hidden" id="SenderContactNoHidden" title="text" name="SenderContactNo" value="">
      <input type="hidden" id="PaymentFileHidden" title="text" name="PaymentFile" value="">




      <div class="row mb-5">
        <label for="reviewSubjectList" class="col-sm-2 col-form-label">Selected Subjects</label>
        <div class="col-sm-8">
        <span id="reviewSubjectList" class="form-control"></span>
      </div>
      </div>

      <div class="row mb-5">
        <label for="SenderName" class="col-sm-2 col-form-label">Sender Name</label>
        <div class="col-sm-8">
          <span id="SenderName" class="form-control"></span>
        </div>
      </div>

      <div class="row mb-5">
        <label for="SenderContactNo" class="col-sm-2 col-form-label">Number</label>
        <div class="col-sm-8">
          <span id="SenderContactNo" class="form-control"></span>
        </div>
      </div>

      <div class="row mb-5">
        <label for="PaymentFile" class="col-sm-2 col-form-label">Proof of Payment</label>
        <div class="col-sm-8">
          <span id="PaymentFile" class="form-control"></span>
        </div>
      </div>

      <div class="row mb-5">
        <label for="ServiceDetails" class="col-sm-2 col-form-label">Reason/s</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="ServiceDetails" name="ServiceDetails" required>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="button" class="btn btn-primary btn-prev">Previous</button>
        <button type="submit" class="btn btn-primary ml-2" onclick="submitForm()">Submit</button>
      </div>
    </form>
    </div>
  </div>
</div>


<script>
  var selectedSubjectIds = [];

  document.addEventListener('DOMContentLoaded', function () {
    function handleCheckboxClick(checkbox) {
      updateCheckboxState();
    }

    var checkboxes = document.getElementsByClassName('selections-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].addEventListener('click', function () {
        handleCheckboxClick(this);
      });
    }

    function updateCheckboxState() {
      var checkboxes = document.querySelectorAll('#selectedSubjectsTable .selections-checkbox:checked');
      var totalUnits = 0;
      checkboxes.forEach(function (checkbox) {
        var units = parseInt(checkbox.closest('tr').getAttribute('data-Units'));
        totalUnits += units;
      });

      document.querySelectorAll('#selectedSubjectsTable .selections-checkbox').forEach(function (checkbox) {
        var units = parseInt(checkbox.closest('tr').getAttribute('data-Units'));
        if (!checkbox.checked && (totalUnits + units) > 6) {
          checkbox.disabled = true;
        } else {
          checkbox.disabled = false;
        }
      });
    }

    updateCheckboxState();
  });

  function handleCheckboxClick(checkbox) {
    var reviewSubjectsTable = document.getElementById('reviewSubjectsTable');
    var reviewHeading = document.getElementById('reviewHeading');
    var reviewTableBody = reviewSubjectsTable.getElementsByTagName('tbody')[0];
    var tr = checkbox.closest('tr');

    if (checkbox.checked) {
      var clonedRow = tr.cloneNode(true);
      clonedRow.querySelector('input[type="checkbox"]').onclick = function () {
        handleCheckboxClick(this);
      };
      reviewTableBody.appendChild(clonedRow);
      reviewSubjectsTable.style.display = 'table';
      tr.style.display = 'none';

      reviewHeading.style.display = 'block';

      var subjectId = checkbox.id.replace('checkbox', '');
      var subjectCode = tr.getAttribute('data-subject-code');
      var subjectName = tr.getAttribute('data-subject-description');
      selectedSubjectIds.push(subjectId);
      document.getElementById('selectedSubjects').value = selectedSubjectIds.join(',');

      var reviewSubjectList = document.getElementById('reviewSubjectList');
      var listItem = document.createElement('li');
      listItem.textContent = `${subjectCode} - ${subjectName}`;
      reviewSubjectList.appendChild(listItem);
    } else {
      Array.from(reviewTableBody.getElementsByTagName('tr')).forEach(function (row) {
        if (row.querySelector('input[type="checkbox"]').id === checkbox.id) {
          reviewTableBody.removeChild(row);
        }
      });

      tr.style.display = '';

      var indexToRemove = selectedSubjectIds.indexOf(checkbox.id);
      if (indexToRemove !== -1) {
        selectedSubjectIds.splice(indexToRemove, 1);
        document.getElementById('selectedSubjects').value = selectedSubjectIds.join(',');
      }

      var reviewSubjectList = document.getElementById('reviewSubjectList');
      reviewSubjectList.removeChild(reviewSubjectList.lastChild);
    }

    updateCheckboxState();

    if (reviewTableBody.getElementsByTagName('tr').length === 0) {
      reviewSubjectsTable.style.display = 'none';
      reviewHeading.style.display = 'none';
    }
  }

  function showResponse() {
    var reviewSubjectList = document.getElementById('reviewSubjectList');
    var senderName = document.getElementById('name').value;
    var mobileNumber = document.getElementById('MobileNumber').value;
    var proofOfPaymentInput = document.getElementById('paymentScreenshot');
    var proofOfPaymentFileName = proofOfPaymentInput.value.split('\\').pop();
    var proofOfPaymentFilePath = proofOfPaymentInput.files[0];

    document.getElementById('SenderName').textContent = senderName;
    document.getElementById('SenderContactNo').textContent = mobileNumber;
    document.getElementById('SenderNameHidden').value = senderName;
    document.getElementById('SenderContactNoHidden').value = mobileNumber;

    if (proofOfPaymentFilePath) {
      var proofOfPaymentLink = document.createElement('a');
      proofOfPaymentLink.textContent = proofOfPaymentFileName;
      proofOfPaymentLink.href = URL.createObjectURL(proofOfPaymentFilePath);
      proofOfPaymentLink.target = '_blank';

      document.getElementById('PaymentFile').innerHTML = '';
      document.getElementById('PaymentFile').appendChild(proofOfPaymentLink);
      document.getElementById('PaymentFileHidden').value = proofOfPaymentFileName;
    }

    var selectedSubjects = [];
    document.querySelectorAll('#reviewSubjectsTable .selections-checkbox:checked').forEach(function (checkbox) {
      var tr = checkbox.closest('tr');
      var subjectCode = tr.getAttribute('data-subject-code');
      var subjectName = tr.getAttribute('data-subject-description');
      selectedSubjects.push(`${subjectCode} - ${subjectName}`);
    });
    document.getElementById('selectedSubjects').value = selectedSubjects.join(',');

    reviewSubjectList.innerHTML = '';
    document.querySelectorAll('#reviewSubjectsTable .selections-checkbox:checked').forEach(function (checkbox, index) {
      var tr = checkbox.closest('tr');
      var subjectCode = tr.getAttribute('data-subject-code');
      var subjectName = tr.getAttribute('data-subject-description');
      var listItem = document.createElement('li');
      listItem.textContent = `${subjectCode} - ${subjectName}`;

      if (index === 0) {
        listItem.style.marginBottom = '10px';
      }

      reviewSubjectList.appendChild(listItem);
    });
  }

</script>


{% endblock content %}




