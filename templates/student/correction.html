{% extends "student/layout.html" %}
{% block content %}
<style>
  /* Your existing styles here */

  .grade-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }

  .grade-table th,
  .grade-table td {
    border: 1px solid #e2e8f0;
    padding: 0.5rem;
    text-align: left;
  }
</style>
<div class="lg:px-40 md:px-16 py-4 w-screen px-8">
  <div class="bg-white w-full rounded-lg p-8 shadow-md grades-container">
      <h3 class="text-2xl font-bold text-c4 mb-3" id="name-number">
          <!-- Your existing content here -->
      </h3>

      <!-- Display student grades here -->
      <div id="gradesContainer"></div>

      <!-- Button to fetch data -->
      <button onclick="fetchStudentSubjectGrade()" class="mt-4 bg-blue-500 text-white p-2 rounded-md">Fetch Grades</button>
  </div>
</div>

<script>
  async function fetchStudentSubjectGrade() {
      try {
          const response = await fetch(`${api_base_url}/grades`);
          if (!response.ok) throw new Error('Failed to fetch data. Try to contact the admin to resolve the issue.');
          const data_grades = await response.json();
          displayGrades(data_grades);
      } catch (error) {
          console.error('Error fetching data:', error.message);
      }
  }

  function displayGrades(data) {
      const gradesContainer = document.getElementById('gradesContainer');
      gradesContainer.innerHTML = ''; // Clear existing content

      data.forEach((entry, index) => {
          // Container for each semester
          const semesterContainer = document.createElement('div');
          semesterContainer.id = `semesterContainer${index}`;
          gradesContainer.appendChild(semesterContainer);

          const table = document.createElement('table');
          table.className = 'grade-table';
          table.innerHTML = `
            <tr>
              <th>Batch</th>
              <th>Sect. Code</th>
              <th>Semester</th>
              <th>GPA</th>
              <th>Subject Code</th>
              <th>Subject</th>
              <th>Units</th>
              <th>Grade</th>
              <th>Status</th>
            </tr>
          `;
          entry.Subject.forEach(subject => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${entry.Batch}</td>
                <td>${subject.SecCode}</td>
                <td>${entry.Semester}</td>
                <td>${entry.GPA}</td>
                <td>${subject.Code}</td>
                <td>${subject.Subject}</td>
                <td>${subject.Units}</td>
                <td>${subject.Grade}</td>
                <td>${subject.Status}</td>
              `;
              table.appendChild(row);
          });
          semesterContainer.appendChild(table);

          // Download button for the table
          const downloadBtn = document.createElement('button');
          downloadBtn.textContent = 'Download Table';
          downloadBtn.className = 'download-btn bg-green-500 text-white p-2 rounded-md mt-2';
          downloadBtn.onclick = () => downloadTableAsCSV(`semesterContainer${index}`);
          semesterContainer.appendChild(downloadBtn);
      });
  }
  function getGradeCell(grade, year, semester, subject, index) {
    if (year === 2020) {
        return `<td>${grade}</td>`;
    } else if (year === 2021 && semester <= 3) {
        return `<td>${grade}</td>`;
    } else if (year === 2022 && semester <= 2) {
        return `<td>${grade}</td>`;
    } else if (year === 2023 && semester === 1) {
        return `<td>${grade}</td>`;
    } else if (year === 2024 && semester === 1 && index < entry.Subject.length - 1) {
        // Erase the grade for the last subject in the table
        return `<td></td>`;
    } else {
        return `<td>${grade}</td>`;
    }
}

  function downloadTableAsCSV(containerId) {
      let data = '';
      const table = document.getElementById(containerId).querySelector('.grade-table');
      const rows = table.querySelectorAll('tr');
      
      for (let i = 0; i < rows.length; i++) {
          const cells = rows[i].querySelectorAll('th, td');
          for (let j = 0; j < cells.length; j++) {
              data += '"' + cells[j].innerText + '"';
              if (j < (cells.length - 1)) data += ',';
          }
          data += '\r\n';
      }

      const blob = new Blob([data], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', `grades-${containerId}.csv`);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
  }
</script>
{% endblock %}
