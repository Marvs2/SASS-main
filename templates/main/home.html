{% extends "main/base.html" %}

{% block content %}
<div class="Box">
    <div class="box1">
        <h1 class="header header animate__bounceIn mt-3">Announcements</h1>

        {% if items %}
        <div id="carouselExampleControls" class="carousel">
            <div class="carousel-inner">
                {% for item in items %}
                    {% if loop.index0 % 3 == 0 %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                    {% endif %}
                    <div class="card">
                        {% if item.ImageUrl %}
                            <img src="{{ item.ImageUrl }}" class="card-img-top" alt="...">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ item.Title }}</h5>

                            <!-- Check if the item is an announcement or an event -->
                            {% if item.IsLive is defined %}
                                <!-- This is an announcement -->
                                <div id="announcementCollapse{{ loop.index }}" class="collapse flex-grow-1">
                                    <div class="card-text announcementCard">
                                        {{ item.Content | safe }}
                                    </div>
                                </div>
                                <div class="text-secondary mb-3">
                                    <hr>
                                </div>
                                <input type="hidden" class="content" value="{{ item.Content }}">
                                <a href="#" class="btn learn-more-btn" data-toggle="collapse" data-target="#announcementCollapse{{ loop.index }}" onclick="toggleCollapse(event, '{{ loop.index }}')">
                                    Read More ...
                                </a>
                            {% else %}
                                <!-- This is an event -->
                                <div id="eventCollapse{{ loop.index }}" class="collapse flex-grow-1">
                                    <div class="card-text announcementCard">
                                        {{ item.Content | safe }}
                                    </div>
                                </div>
                                <div class="text-secondary mb-3">
                                    <hr>
                                </div>
                                <input type="hidden" class="content" value="{{ item.Content }}">
                                <a href="#" class="btn learn-more-btn" data-toggle="collapse" data-target="#eventCollapse{{ loop.index }}" onclick="toggleCollapse(event, '{{ loop.index }}')">
                                    Read More ...
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {% if loop.index0 % 3 == 2 or loop.last %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p>No items available.</p>
        {% endif %}
    </div>
</div>

<script>
    // Retrieve all elements with class name 'announcementCard' and 'content'
    const itemCards = document.querySelectorAll(".announcementCard");
    const contentInputs = document.querySelectorAll(".content");

    // Function to toggle collapse manually
    function toggleCollapse(event, index) {
        event.preventDefault();  // Prevent the default behavior of the anchor element

        // Determine if it's an announcement or an event based on the element ID
        const isAnnouncement = event.target.dataset.target.includes("announcementCollapse");

        const collapseElementId = isAnnouncement ? "announcementCollapse" : "eventCollapse";
        const collapseElement = document.getElementById(collapseElementId + index);
        const isCollapsed = collapseElement.classList.contains("show");

        // Collapse any open sections
        document.querySelectorAll('.collapse.show').forEach((element) => {
            element.classList.remove("show");
            // Change "See Less" to "Learn More" when collapsing
            const currentIndex = element.id.replace(collapseElementId, "");
            document.querySelector(`[data-target="#${collapseElementId}${currentIndex}"]`).innerHTML = "Read More";
        });

        if (!isCollapsed) {
            // Change "Learn More" to "See Less" when expanding
            document.querySelector(`[data-target="#${collapseElementId}${index}"]`).innerHTML = "See Less";

            // Scroll to the bottom of the expanded content if the button is not visible
            const buttonElement = event.target;
            if (!isElementInViewport(buttonElement)) {
                const contentBottom = collapseElement.offsetTop + collapseElement.scrollHeight;
                window.scrollTo({ top: contentBottom, behavior: "smooth" });
            }

            collapseElement.classList.add("show");
        }
    }

    // Function to check if an element is in the viewport
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    // Iterate over each element and set its innerHTML
    itemCards.forEach((itemCard, index) => {
        const contentValue = contentInputs[index].value;
        itemCard.innerHTML = contentValue;
    });
</script>

{% endblock %}
